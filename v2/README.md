# SSH Credential Checker

## Описание

Данный скрипт на Python предназначен для проверки SSH-учетных данных на удалённых серверах. Он читает список IP-адресов, портов, имён пользователей и паролей из файла, пытается подключиться к каждому из них по SSH и записывает результаты в лог-файлы. Успешные попытки аутентификации сохраняются в отдельном файле.

Скрипт использует асинхронные операции для повышения производительности и поддерживает цветовую подсветку вывода в консоли для улучшения читаемости.

## Требования

- **Python 3.7** или выше.

### Установка необходимых пакетов

Установите необходимые пакеты с помощью `pip`:

```bash
pip install paramiko aiofiles
```

## Конфигурация

Скрипт использует файл `config.json` для настройки параметров SSH-соединения и асинхронной работы.

### Пример файла `config.json`

```json
{
    "ssh": {
        "timeout": 10,
        "max_retries": 1,
        "auth_timeout": 10,
        "banner_timeout": 10,
        "allow_agent": false,
        "look_for_keys": false,
        "success_file": "success.txt"
    },
    "async": {
        "max_workers": 10
    }
}
```

### Описание параметров

- **ssh**
  - `timeout`: Общий таймаут для попытки соединения (в секундах).
  - `max_retries`: Максимальное количество попыток подключения.
  - `auth_timeout`: Таймаут для аутентификации.
  - `banner_timeout`: Таймаут для получения баннера SSH-сервера.
  - `allow_agent`: Разрешить использование SSH-агента.
  - `look_for_keys`: Искать приватные ключи в стандартных местах.
  - `success_file`: Имя файла для записи успешных попыток.

- **async**
  - `max_workers`: Максимальное количество потоков для параллельной проверки.

## Формат файла с учетными данными

Файл с учетными данными должен содержать строки в следующем формате:

```
<IP-адрес>:<порт>;<имя пользователя>;<пароль>
```

- **Разделители**:
  - `:` между IP-адресом и портом.
  - `;` между портом, именем пользователя и паролем.
- **Комментарии**:
  - Строки, начинающиеся с `#`, игнорируются.
  - Можно использовать `|` для добавления комментария в конце строки.

### Пример файла `credentials.txt`

```
192.168.1.1:22;user1;password1
192.168.1.2:2222;user2;password2 | это комментарий
# Эта строка комментария будет игнорироваться
192.168.1.3:22;user3;password3
```

## Использование

Запустите скрипт из командной строки, передав путь к файлу с учетными данными в качестве аргумента.

### Синтаксис

```bash
python your_script.py <путь_к_файлу_учетных_данных>
```

### Пример запуска

```bash
python ssh_checker.py credentials.txt
```

## Описание работы скрипта

1. **Загрузка конфигурации**: Скрипт считывает настройки из файла `config.json`.
2. **Загрузка учетных данных**: Считывает список IP-адресов, портов, имён пользователей и паролей из указанного файла.
3. **Проверка учетных данных**: Пытается подключиться к каждому серверу по SSH с использованием указанных учетных данных.
4. **Логирование результатов**: Записывает результаты каждой попытки в соответствующий лог-файл.
5. **Запись успешных попыток**: Успешные подключения сохраняются в файл, указанный в `success_file` в конфигурации.
6. **Вывод статистики**: После завершения проверки выводит статистику по успешным и неудачным попыткам.

## Функции и классы

### Класс `Colors`

Класс для цветовой подсветки вывода в консоль с использованием ANSI escape последовательностей.

- **Атрибуты**:
  - `HEADER`, `OKBLUE`, `OKGREEN`, `WARNING`, `ERROR`, `CRITICAL`, `ENDC`, `BOLD`, `UNDERLINE`, `PURPLE`, `ORANGE`, `DARK_ORANGE`, `INFO`.

### Класс `CustomFormatter(logging.Formatter)`

Пользовательский форматтер для логирования, добавляющий цветовую подсветку времени и уровня логов.

- **Методы**:
  - `format(record)`: Форматирует сообщение логирования с цветовой подсветкой.

### Функция `setup_logging()`

Настраивает систему логирования.

- Создает обработчики для разных уровней логирования и соответствующие лог-файлы.
- Добавляет цветовую подсветку для консольного вывода.

### Функция `load_config(file_path='config.json')`

Загружает конфигурационные параметры из JSON-файла.

- **Параметры**:
  - `file_path` (str): Путь к файлу конфигурации (по умолчанию `'config.json'`).
- **Возвращает**:
  - `dict`: Словарь с конфигурационными параметрами.
- **Исключения**:
  - `FileNotFoundError`: Если файл конфигурации не найден.
  - `json.JSONDecodeError`: Если файл содержит некорректный JSON.

### Асинхронная функция `check_ssh_credentials(host, port, username, password, config, success_file)`

Проверяет SSH-учетные данные для указанного хоста.

- **Параметры**:
  - `host` (str): IP-адрес или имя хоста.
  - `port` (int): Порт SSH.
  - `username` (str): Имя пользователя.
  - `password` (str): Пароль пользователя.
  - `config` (dict): Конфигурационные параметры.
  - `success_file` (str): Путь к файлу для записи успешных попыток.
- **Возвращает**:
  - `dict`: Результат проверки (статус и сообщение).

### Асинхронная функция `load_credentials(file_path)`

Загружает список учетных данных из файла.

- **Параметры**:
  - `file_path` (str): Путь к файлу с учетными данными.
- **Возвращает**:
  - `list`: Список кортежей `(host, port, username, password)`.
- **Исключения**:
  - `FileNotFoundError`: Если файл не найден.
  - `Exception`: При возникновении ошибок чтения файла.

### Асинхронная функция `check_credentials_in_threads(credentials, max_workers, config, success_file)`

Проверяет учетные данные, используя пул потоков для параллелизации.

- **Параметры**:
  - `credentials` (list): Список учетных данных для проверки.
  - `max_workers` (int): Максимальное количество потоков.
  - `config` (dict): Конфигурационные параметры.
  - `success_file` (str): Путь к файлу для записи успешных попыток.
- **Возвращает**:
  - `list`: Список результатов проверки.

### Функция `print_statistics(results, start_time)`

Выводит статистику работы скрипта после завершения проверки.

- **Параметры**:
  - `results` (list): Список результатов проверки.
  - `start_time` (float): Время начала выполнения скрипта.

### Асинхронная функция `main(credentials_file)`

Главная функция скрипта.

- **Параметры**:
  - `credentials_file` (str): Путь к файлу с учетными данными.
- **Действия**:
  - Настраивает логирование.
  - Загружает конфигурацию.
  - Загружает учетные данные.
  - Запускает проверку учетных данных.
  - Выводит статистику выполнения.

## Логирование

Скрипт использует логирование для записи результатов и ошибок.

- **Лог-файлы**:
  - `debug.log`
  - `info.log`
  - `warning.log`
  - `error.log`
  - `critical.log`
- **Консольный вывод**:
  - Сообщения выводятся с цветовой подсветкой для улучшения читаемости.

## Вывод статистики

После завершения проверки скрипт выводит статистику:

- Количество успешных попыток.
- Количество ошибок.
- Общее количество проверенных IP-адресов.
- Время выполнения.

### Пример вывода статистики

```
Статистика выполнения:
Успешные попытки: 2
Ошибки: 1
Общее количество проверенных IP: 3
Время выполнения: 12.34 секунд
```

## Обработка ошибок

Скрипт обрабатывает и логирует различные исключения:

- **Ошибки аутентификации**: `paramiko.AuthenticationException`.
- **Некорректный ключ хоста**: `paramiko.BadHostKeyException`.
- **Общие ошибки SSH**: `paramiko.SSHException`.
- **Таймауты**: `socket.timeout`.
- **Ошибки сокета**: `socket.error`.
- **Неизвестные ошибки**: Любые другие исключения.

## Прерывание выполнения

При нажатии `Ctrl+C` скрипт корректно обрабатывает прерывание и выводит сообщение:

```
Прерывание выполнения пользователем.
```

## Важные замечания

- **Законность**: Используйте этот скрипт только для проверки серверов, на которые вы имеете разрешение подключаться.
- **Ответственность**: Автор скрипта не несет ответственности за любое несанкционированное использование.
- **Этика**: Уважайте законы и правила, касающиеся доступа к чужим системам.

## Поддержка

Если у вас есть вопросы или предложения, пожалуйста, создайте issue в репозитории проекта или свяжитесь с автором напрямую.

## Лицензия

Этот проект лицензирован под лицензией MIT. Подробности см. в файле `LICENSE`.

# Пример использования

1. Создайте файл `credentials.txt` с учетными данными в указанном формате.
2. Убедитесь, что файл `config.json` настроен под ваши требования.
3. Запустите скрипт:

   ```bash
   python ssh_checker.py credentials.txt
   ```

4. После завершения работы скрипта проверьте файлы логов и файл с успешными попытками (`success.txt` по умолчанию).

# Заключение

Данный скрипт предоставляет эффективный способ проверки SSH-учетных данных на удалённых серверах с использованием асинхронных операций и цветного логирования для удобства анализа результатов.
